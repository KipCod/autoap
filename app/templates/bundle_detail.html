{% extends "layout.html" %}
{% block content %}
<section class="bundle-detail">
    <h2>{{ bundle.bundle_name }} (ID {{ bundle.id }}) — {{ active_dataset.label if active_dataset else '' }}</h2>
    <form action="/bundle/{{ bundle.id }}/delete" method="post" class="danger">
        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
        <button type="submit" onclick="return confirm('Delete this bundle?');">Delete</button>
    </form>

    <form action="/bundle/{{ bundle.id }}/update" method="post" class="bundle-form">
        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
        <label>Part
            <input type="text" name="part" value="{{ bundle.part }}" required>
        </label>
        <label>Bundle Name
            <input type="text" name="bundle_name" value="{{ bundle.bundle_name }}" required>
        </label>
        <label>Keywords
            <input type="text" name="keywords" value="{{ bundle.keywords }}">
        </label>
        <label>Command
            <textarea name="command_text" rows="6">{{ bundle.command_text }}</textarea>
        </label>
        <p class="hint">Commands detected: {{ commands | length }}</p>
        <p class="hint">Description은 아래 Command Memos 섹션에서 명령어별로 관리합니다.</p>
        <button type="submit">Update Bundle</button>
    </form>
</section>

<section class="memo-section">
    <h3>Command Memos</h3>
    <form action="/bundle/{{ bundle.id }}/memos" method="post">
        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Command</th>
                    <th>Description</th>
                    <th>Memo</th>
                    <th>OneNote Link</th>
                </tr>
            </thead>
            <tbody>
            {% for memo in memos %}
                <tr>
                    <td>{{ memo.command_order }}</td>
                    <td><code>{{ memo.command_text }}</code></td>
                    <td>
                        <textarea name="description_{{ memo.command_order }}" rows="2">{{ memo.description }}</textarea>
                    </td>
                    <td>
                        <textarea name="memo_text_{{ memo.command_order }}" rows="2">{{ memo.memo_text }}</textarea>
                    </td>
                    <td>
                        <input type="url" name="onenote_link_{{ memo.command_order }}" value="{{ memo.onenote_link }}">
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <button type="submit">Save Memo Updates</button>
    </form>
</section>

<section class="bundle-links" id="bundle-links">
    <h3>참고 링크</h3>
    <div class="link-form-panel">
        <form action="/links" method="post" class="bundle-form multi-link-form">
            <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
            <input type="hidden" name="return_to" value="/bundle/{{ bundle.id }}?dataset={{ active_dataset_id }}#bundle-links">
            <input type="hidden" name="bundle_default" value="{{ bundle.id }}">
            <label>Link Entries
                <textarea name="link_entries" rows="5" placeholder="https://example.com | description | tags | command #"></textarea>
            </label>
            <p class="hint">각 줄은 하나의 링크입니다. Description, Tags, Command #는 <code>|</code> 로 구분하여 선택 입력하세요.</p>
            <label>Default Command Target
                <select name="command_default">
                    <option value="">전체 번들</option>
                    {% for memo in memos %}
                    <option value="{{ memo.command_order }}">{{ memo.command_order }}. {{ memo.command_text }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Global Tags (전체 링크)
                <input type="text" name="global_tags" placeholder="예: urgent, doc">
            </label>
            <button type="submit">Save Links</button>
        </form>
    </div>

    {% if bundle_links %}
    <table class="link-table compact">
        <thead>
            <tr>
                <th>URL</th>
                <th>Description</th>
                <th>Tags</th>
                <th>Target</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for item in bundle_links %}
            <tr>
                <td><a href="{{ item.entry.url }}" target="_blank" rel="noopener">{{ item.entry.url }}</a></td>
                <td>{{ item.entry.description or '—' }}</td>
                <td>{{ item.entry.tags or '—' }}</td>
                <td>
                    {% if item.command_label %}
                        #{{ item.entry.command_order }} — {{ item.command_label }}
                    {% else %}
                        전체 번들
                    {% endif %}
                </td>
                <td>
                    <form method="post" action="/links/{{ item.entry.id }}/delete">
                        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
                        <input type="hidden" name="return_to" value="/bundle/{{ bundle.id }}?dataset={{ active_dataset_id }}#bundle-links">
                        <button type="submit" class="link-delete">삭제</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>등록된 링크가 없습니다.</p>
    {% endif %}
</section>

{% endblock %}


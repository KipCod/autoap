{% extends "layout.html" %}
{% block content %}
<section class="dataset-tabs">
    {% for dataset in datasets %}
    <a class="tab-button {{ 'active' if dataset.id == active_dataset_id else '' }}"
       href="/?dataset={{ dataset.id }}&view={{ view }}{% if query and view == 'bundles' %}&query={{ query | urlencode }}{% endif %}">
        {{ dataset.label }}
    </a>
    {% endfor %}
</section>

<section class="view-tabs">
    <a class="tab-button {{ 'active' if view == 'bundles' else '' }}" href="/?dataset={{ active_dataset_id }}&view=bundles">Bundles</a>
    <a class="tab-button {{ 'active' if view == 'links' else '' }}" href="/?dataset={{ active_dataset_id }}&view=links">Links</a>
</section>

{% if view == 'bundles' %}
<section class="toolbar">
    <form method="get" action="/">
        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
        <input type="hidden" name="view" value="bundles">
        <input type="text" name="query" placeholder="Search by bundle or keywords" value="{{ query }}">
        <button type="submit">Search</button>
    </form>
</section>

{% if keyword_candidates %}
<section class="keyword-chips">
    <strong>추천 키워드:</strong>
    <div class="chip-row">
        {% for keyword in keyword_candidates %}
        <button class="chip" type="button" data-keyword="{{ keyword }}">{{ keyword }}</button>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if bundles %}
<section class="bundle-grid">
    {% for item in bundles %}
    <article class="bundle-card">
        <header>
            <h2><a href="/bundle/{{ item.bundle.id }}?dataset={{ active_dataset_id }}">{{ item.bundle.bundle_name }}</a></h2>
            <span class="part">{{ item.bundle.part }}</span>
        </header>
        <ol class="command-list">
            {% for command in item.commands %}
            <li>{{ command }}</li>
            {% endfor %}
        </ol>
    </article>
    {% endfor %}
</section>
{% else %}
<p>등록된 번들이 없습니다. <a href="/bundle/new?dataset={{ active_dataset_id }}">첫 번들을 추가해보세요.</a></p>
{% endif %}
{% endif %}

{% if view == 'links' %}
<section class="link-manager">
    <form method="post" action="/links" class="bundle-form link-form">
        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
        <input type="hidden" name="return_to" value="/?dataset={{ active_dataset_id }}&view=links">
        <label>URL
            <input type="url" name="url" placeholder="https://example.com" required>
        </label>
        <label>Description
            <textarea name="description" rows="2" placeholder="링크 설명을 입력하세요."></textarea>
        </label>
        <label>Tags
            <input type="text" name="tags" placeholder="쉼표로 구분된 태그 (선택)">
        </label>
        <label>Bundle (선택)
            <select name="bundle_id">
                <option value="">공용 링크</option>
                {% for option in bundle_options %}
                <option value="{{ option.id }}">{{ option.bundle_name }}</option>
                {% endfor %}
            </select>
        </label>
        <button type="submit">링크 추가</button>
    </form>

    {% if links %}
    <table class="link-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Bundle</th>
                <th>Command</th>
                <th>URL</th>
                <th>Description</th>
                <th>Tags</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for item in links %}
            <tr>
                <td>{{ item.entry.id }}</td>
                <td>{{ item.bundle.bundle_name if item.bundle else '공용' }}</td>
                <td>
                    {% if item.command_label %}
                        #{{ item.entry.command_order }} — {{ item.command_label }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td><a href="{{ item.entry.url }}" target="_blank" rel="noopener">{{ item.entry.url }}</a></td>
                <td>{{ item.entry.description or '—' }}</td>
                <td>{{ item.entry.tags or '—' }}</td>
                <td>
                    <form method="post" action="/links/{{ item.entry.id }}/delete">
                        <input type="hidden" name="dataset" value="{{ active_dataset_id }}">
                        <input type="hidden" name="return_to" value="/?dataset={{ active_dataset_id }}&view=links">
                        <button type="submit" class="link-delete">삭제</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>등록된 링크가 없습니다.</p>
    {% endif %}
</section>
{% endif %}

<script>
const keywordButtons = document.querySelectorAll(".chip[data-keyword]");
const searchInput = document.querySelector('input[name="query"]');
keywordButtons.forEach((button) => {
    button.addEventListener("click", () => {
        if (searchInput) {
            searchInput.value = button.dataset.keyword;
            searchInput.form.submit();
        }
    });
});
</script>
{% endblock %}

